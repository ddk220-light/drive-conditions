<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Drive Conditions - Route Weather Forecast</title>
<style>
/* ── Reset & Base ────────────────────────────────────── */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  background: #f0f2f5;
  color: #1a1a2e;
  height: 100vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* ── Header / Form Bar ───────────────────────────────── */
.header {
  background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
  padding: 14px 24px;
  display: flex;
  align-items: center;
  gap: 16px;
  flex-wrap: wrap;
  box-shadow: 0 2px 12px rgba(0,0,0,0.25);
  z-index: 10;
}

.header .logo {
  font-size: 20px;
  font-weight: 700;
  color: #e2e8f0;
  letter-spacing: -0.3px;
  white-space: nowrap;
  display: flex;
  align-items: center;
  gap: 8px;
}

.header .logo .icon {
  font-size: 22px;
  display: inline-flex;
}

.form-group {
  display: flex;
  align-items: center;
  gap: 10px;
  flex: 1;
  min-width: 0;
  flex-wrap: wrap;
}

.form-group label {
  color: #94a3b8;
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  white-space: nowrap;
}

.form-group input {
  padding: 8px 14px;
  border: 1px solid #334155;
  border-radius: 8px;
  background: #0f172a;
  color: #e2e8f0;
  font-size: 14px;
  outline: none;
  transition: border-color 0.2s, box-shadow 0.2s;
  min-width: 0;
}

.form-group input:focus {
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59,130,246,0.2);
}

.form-group input[type="text"] { width: 200px; }
.form-group input[type="datetime-local"] { width: 210px; }

#btn-swap {
  background: none;
  border: 1px solid #334155;
  border-radius: 6px;
  color: #94a3b8;
  font-size: 18px;
  padding: 4px 8px;
  cursor: pointer;
  transition: color 0.2s, border-color 0.2s;
  line-height: 1;
}
#btn-swap:hover {
  color: #e2e8f0;
  border-color: #3b82f6;
}

/* Google Places Autocomplete element styling */
.form-group gmp-place-autocomplete {
  width: 200px;
  --gmpx-color-surface: #0f172a;
  --gmpx-color-on-surface: #e2e8f0;
  --gmpx-color-on-surface-variant: #94a3b8;
  --gmpx-color-primary: #3b82f6;
  --gmpx-font-family-base: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  --gmpx-font-size-base: 14px;
}

#btn-route {
  padding: 9px 24px;
  background: linear-gradient(135deg, #3b82f6, #2563eb);
  color: #fff;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: transform 0.1s, box-shadow 0.2s;
  white-space: nowrap;
}

#btn-route:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(59,130,246,0.4); }
#btn-route:active { transform: translateY(0); }
#btn-route:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

/* ── Departure Slider Bar ───────────────────────────── */
.slider-bar {
  background: #1e293b;
  padding: 10px 24px 12px;
  border-top: 1px solid #334155;
}

.slider-label {
  color: #e2e8f0;
  font-size: 14px;
  font-weight: 600;
  text-align: center;
  margin-bottom: 6px;
}

.slider-row {
  display: flex;
  align-items: center;
  gap: 12px;
}

.slider-bound {
  color: #64748b;
  font-size: 11px;
  white-space: nowrap;
  min-width: 100px;
}

.slider-bound:last-child {
  text-align: right;
}

#departure-slider {
  flex: 1;
  -webkit-appearance: none;
  appearance: none;
  height: 6px;
  background: #334155;
  border-radius: 3px;
  outline: none;
  cursor: pointer;
}

#departure-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 18px;
  height: 18px;
  background: #3b82f6;
  border-radius: 50%;
  border: 2px solid #e2e8f0;
  cursor: pointer;
  transition: transform 0.1s;
}

#departure-slider::-webkit-slider-thumb:hover {
  transform: scale(1.2);
}

#departure-slider::-moz-range-thumb {
  width: 18px;
  height: 18px;
  background: #3b82f6;
  border-radius: 50%;
  border: 2px solid #e2e8f0;
  cursor: pointer;
}

/* ── Trip Settings Bar ────────────────────────────────── */
.settings-bar {
  background: #1e293b;
  padding: 10px 24px 12px;
  border-top: 1px solid #334155;
  display: none;
}

.settings-row {
  display: flex;
  align-items: center;
  gap: 20px;
  flex-wrap: wrap;
}

.setting-group {
  display: flex;
  align-items: center;
  gap: 8px;
}

.setting-group label {
  color: #94a3b8;
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  white-space: nowrap;
}

.setting-group input[type="range"] {
  width: 120px;
  -webkit-appearance: none;
  appearance: none;
  height: 4px;
  background: #334155;
  border-radius: 2px;
  outline: none;
}

.setting-group input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 14px;
  height: 14px;
  background: #3b82f6;
  border-radius: 50%;
  border: 2px solid #e2e8f0;
  cursor: pointer;
}

.setting-group input[type="number"] {
  width: 60px;
  padding: 4px 8px;
  border: 1px solid #334155;
  border-radius: 6px;
  background: #0f172a;
  color: #e2e8f0;
  font-size: 13px;
}

.setting-value {
  color: #e2e8f0;
  font-size: 13px;
  font-weight: 600;
  min-width: 40px;
}

.setting-toggle {
  display: flex;
  align-items: center;
  gap: 6px;
  cursor: pointer;
}

.setting-toggle input[type="checkbox"] {
  accent-color: #3b82f6;
}

.rest-options {
  display: none;
}

.rest-options.visible {
  display: flex;
  gap: 16px;
}

/* ── Main Layout ─────────────────────────────────────── */
.main {
  flex: 1;
  display: flex;
  overflow: hidden;
  position: relative;
}

#map {
  flex: 1;
  min-width: 0;
}

/* ── Instructions Panel ──────────────────────────────── */
.panel {
  width: 400px;
  min-width: 360px;
  background: #fff;
  overflow-y: auto;
  border-left: 1px solid #e2e8f0;
  display: flex;
  flex-direction: column;
}

.panel-header {
  padding: 16px 20px;
  background: #f8fafc;
  border-bottom: 1px solid #e2e8f0;
  position: sticky;
  top: 0;
  z-index: 5;
}

.panel-header h2 {
  font-size: 15px;
  font-weight: 700;
  color: #1e293b;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

.route-meta {
  display: flex;
  gap: 16px;
  margin-top: 8px;
  font-size: 13px;
  color: #64748b;
}

.route-meta span { display: flex; align-items: center; gap: 4px; }

.panel-body {
  flex: 1;
  overflow-y: auto;
  padding: 0;
}

.panel-placeholder {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  color: #94a3b8;
  text-align: center;
  padding: 40px 20px;
}

.panel-placeholder .big-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
.panel-placeholder p { font-size: 14px; line-height: 1.6; }

/* ── Segment Cards ───────────────────────────────────── */
.segment-card {
  padding: 16px 20px;
  border-bottom: 1px solid #f1f5f9;
  transition: background-color 0.15s;
  cursor: pointer;
  position: relative;
}

.segment-card:hover { background-color: #f8fafc; }

.segment-card.active { background-color: #eff6ff; }

.segment-card .severity-bar {
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 4px;
}

.severity-bar.green  { background: #22c55e; }
.severity-bar.yellow { background: #eab308; }
.severity-bar.red    { background: #ef4444; }

.segment-header {
  display: flex;
  align-items: baseline;
  justify-content: space-between;
  margin-bottom: 6px;
}

.segment-time {
  font-size: 14px;
  font-weight: 700;
  color: #1e293b;
}

.segment-mile {
  font-size: 12px;
  color: #94a3b8;
  font-weight: 500;
}

.station-badge {
  background: #e8f5e9;
  color: #2e7d32;
  font-size: .7rem;
  padding: 1px 6px;
  border-radius: 8px;
  font-weight: 600;
  margin-left: auto;
}

.light-indicator {
  font-size: 12px;
  color: #64748b;
  margin-top: 2px;
  display: flex;
  align-items: center;
  gap: 4px;
}

.light-indicator.twilight { color: #d97706; }
.light-indicator.night { color: #6366f1; }

.light-warning {
  margin-top: 4px;
  padding: 4px 8px;
  background: #fef3c7;
  border-left: 3px solid #d97706;
  border-radius: 4px;
  font-size: 11px;
  font-weight: 600;
  color: #92400e;
}

.rest-stop-card {
  padding: 12px 20px;
  border-bottom: 1px solid #f1f5f9;
  background: #eff6ff;
}

.rest-stop-card .rest-header {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
  font-weight: 600;
  color: #1e40af;
}

.rest-stop-card .rest-detail {
  font-size: 12px;
  color: #64748b;
  margin-top: 2px;
}

.segment-weather {
  font-size: 13px;
  color: #475569;
  line-height: 1.5;
  margin-bottom: 6px;
}

.segment-weather .temp {
  font-weight: 600;
  color: #1e293b;
}

.segment-weather .precip-badge {
  display: inline-block;
  padding: 1px 7px;
  border-radius: 10px;
  font-size: 11px;
  font-weight: 600;
  margin-left: 4px;
}

.precip-badge.light   { background: #dbeafe; color: #1d4ed8; }
.precip-badge.moderate { background: #fef3c7; color: #92400e; }
.precip-badge.heavy   { background: #fee2e2; color: #991b1b; }

.segment-instruction {
  font-size: 13px;
  color: #64748b;
  padding-left: 18px;
  position: relative;
}

.segment-instruction::before {
  content: "\25B6";
  position: absolute;
  left: 0;
  font-size: 10px;
  top: 2px;
  color: #94a3b8;
}

.segment-instruction.arrival::before {
  content: "\2713";
  color: #22c55e;
  font-weight: bold;
}

.segment-wind {
  font-size: 12px;
  color: #64748b;
  margin-top: 4px;
  display: flex;
  align-items: center;
  gap: 4px;
}

.wind-arrow {
  display: inline-block;
  font-size: 14px;
  line-height: 1;
}

.segment-fog {
  font-size: 12px;
  color: #6b7280;
  margin-top: 2px;
  font-style: italic;
}

.segment-alert {
  margin-top: 6px;
  padding: 6px 10px;
  background: #fef3c7;
  border-left: 3px solid #f59e0b;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 600;
  color: #92400e;
}

.segment-alert.severe {
  background: #fee2e2;
  border-left-color: #ef4444;
  color: #991b1b;
}

.segment-sources {
  margin-top: 8px;
  padding-top: 6px;
  border-top: 1px solid #f1f5f9;
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}

.segment-sources a {
  font-size: 11px;
  color: #64748b;
  text-decoration: none;
  transition: color 0.15s;
}

.segment-sources a:hover {
  color: #3b82f6;
  text-decoration: underline;
}

/* ── Alert Banner ────────────────────────────────────── */
.alert-banner {
  padding: 12px 20px;
  border-bottom: 1px solid #fde68a;
  display: flex;
  align-items: flex-start;
  gap: 10px;
}

.alert-banner.moderate { background: #fffbeb; }
.alert-banner.severe, .alert-banner.extreme { background: #fef2f2; border-bottom-color: #fecaca; }
.alert-banner.minor { background: #f0fdf4; border-bottom-color: #bbf7d0; }

.alert-banner .alert-icon { font-size: 18px; flex-shrink: 0; margin-top: 1px; }
.alert-banner .alert-text { font-size: 13px; font-weight: 600; color: #1e293b; }
.alert-banner .alert-detail { font-size: 12px; color: #64748b; margin-top: 2px; }

/* ── Route Summary Bar ───────────────────────────────── */
.summary-bar {
  background: #1e293b;
  color: #e2e8f0;
  padding: 12px 24px;
  font-size: 13px;
  line-height: 1.5;
  display: none;
  z-index: 10;
  flex-shrink: 0;
}

.summary-bar .summary-text { margin-bottom: 4px; }
.summary-bar .sources {
  font-size: 11px;
  color: #64748b;
}

/* ── Loading Overlay ─────────────────────────────────── */
.loading-overlay {
  position: absolute;
  inset: 0;
  background: rgba(255,255,255,0.85);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 100;
  flex-direction: column;
  gap: 16px;
}

.loading-overlay.visible { display: flex; }

.spinner {
  width: 44px;
  height: 44px;
  border: 4px solid #e2e8f0;
  border-top-color: #3b82f6;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

.loading-text {
  font-size: 14px;
  color: #64748b;
  font-weight: 500;
}

/* ── Error Toast ─────────────────────────────────────── */
.error-toast {
  position: fixed;
  top: 80px;
  left: 50%;
  transform: translateX(-50%) translateY(-20px);
  background: #fef2f2;
  border: 1px solid #fecaca;
  color: #991b1b;
  padding: 12px 20px;
  border-radius: 10px;
  font-size: 14px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.15);
  z-index: 200;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s, transform 0.3s;
  max-width: 500px;
  text-align: center;
}

.error-toast.visible {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
  pointer-events: auto;
}

/* ── Info Window Styles (for Google Maps) ────────────── */
.iw-content {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  font-size: 13px;
  line-height: 1.5;
  color: #1e293b;
  max-width: 240px;
}

.iw-content .iw-title {
  font-weight: 700;
  font-size: 14px;
  margin-bottom: 6px;
}

.iw-content .iw-row {
  display: flex;
  justify-content: space-between;
  padding: 2px 0;
}

.iw-content .iw-label { color: #64748b; }

/* ── Responsive ──────────────────────────────────────── */
@media (max-width: 900px) {
  .main { flex-direction: column; }
  .panel { width: 100%; min-width: 0; border-left: none; border-top: 1px solid #e2e8f0; max-height: 45vh; }
  #map { min-height: 40vh; }
  .form-group input[type="text"] { width: 150px; }
}
</style>
</head>
<body>

<!-- ── Header / Form ──────────────────────────────────── -->
<div class="header">
  <div class="logo">
    <span class="icon">&#9729;</span>
    Drive Conditions
  </div>
  <div class="form-group">
    <label for="origin">From</label>
    <input type="text" id="origin" value="San Mateo, CA" placeholder="Origin">
    <button type="button" id="btn-swap" title="Swap origin and destination">&#8646;</button>
    <label for="destination">To</label>
    <input type="text" id="destination" value="Mendocino, CA" placeholder="Destination">
    <label for="departure">Depart</label>
    <input type="datetime-local" id="departure">
    <button id="btn-route">Get Route</button>
  </div>
</div>

<!-- ── Departure Slider ────────────────────────────────── -->
<div class="slider-bar" id="slider-bar" style="display:none;">
  <div class="slider-label" id="slider-label">Departure: --</div>
  <div class="slider-row">
    <span class="slider-bound" id="slider-min-label">--</span>
    <input type="range" id="departure-slider" min="0" max="96" value="48" step="1">
    <span class="slider-bound" id="slider-max-label">--</span>
  </div>
</div>

<!-- ── Trip Settings ─────────────────────────────────── -->
<div class="settings-bar" id="settings-bar">
  <div class="settings-row">
    <div class="setting-group">
      <label>Speed</label>
      <input type="range" id="speed-slider" min="0.50" max="1.00" step="0.05" value="1.00">
      <span class="setting-value" id="speed-value">1.00x</span>
    </div>
    <div class="setting-group setting-toggle">
      <input type="checkbox" id="rest-toggle">
      <label for="rest-toggle">Rest Stops</label>
    </div>
    <div class="rest-options" id="rest-options">
      <div class="setting-group">
        <label>Drive</label>
        <input type="number" id="rest-interval" value="60" min="30" max="180" step="15">
        <span class="setting-value">min</span>
      </div>
      <div class="setting-group">
        <label>Rest</label>
        <input type="number" id="rest-duration" value="20" min="5" max="60" step="5">
        <span class="setting-value">min</span>
      </div>
    </div>
  </div>
</div>

<!-- ── Main Content ───────────────────────────────────── -->
<div class="main">
  <div id="map"></div>
  <div class="panel">
    <div class="panel-header">
      <h2>Driving Instructions</h2>
      <div class="route-meta" id="route-meta" style="display:none;">
        <span id="meta-distance"></span>
        <span id="meta-duration"></span>
        <span id="meta-route"></span>
      </div>
    </div>
    <div id="alerts-container"></div>
    <div class="panel-body" id="panel-body">
      <div class="panel-placeholder" id="placeholder">
        <div class="big-icon">&#128663;</div>
        <p>Enter your origin and destination,<br>then click <strong>Get Route</strong> to see<br>weather conditions along your drive.</p>
      </div>
    </div>
  </div>
  <div class="loading-overlay" id="loading">
    <div class="spinner"></div>
    <div class="loading-text">Fetching route &amp; weather data...</div>
  </div>
</div>

<!-- ── Summary Bar ────────────────────────────────────── -->
<div class="summary-bar" id="summary-bar">
  <div class="summary-text" id="summary-text"></div>
  <div class="sources" id="sources-text"></div>
</div>

<!-- ── Error Toast ────────────────────────────────────── -->
<div class="error-toast" id="error-toast"></div>

<!-- ── Google Maps JS API ─────────────────────────────── -->
<script>
(g=>{var h,a,k,p="The Google Maps JavaScript API",c="google",l="importLibrary",q="__aw__",m="__gjsload__",aa=/__gjsload__/,e=globalThis,d=e[c]||(e[c]={}),b=d.maps||(d.maps={}),r=new Set,t=new URLSearchParams,u=()=>h||(h=new Promise(async(f,n)=>{await (a=e.document.createElement("script"));t.set("libraries",[...r]+"");for(k in g)t.set(k.replace(/[A-Z]/g,j=>"_"+j[0].toLowerCase()),g[k]);t.set("callback",c+".maps."+q);a.src=`https://maps.googleapis.com/maps/api/js?`+t;d.maps[q]=f;a.onerror=()=>h=n(Error(p+" could not load."));a.nonce=e.document.querySelector("script[nonce]")?.nonce||"";e.document.head.append(a)}));b[l]?console.warn(p+" only loads once."):b[l]=(f,...n)=>r.add(f)&&u().then(()=>b[l](f,...n))})({
  key: "{{ google_api_key }}",
  v: "weekly",
});
</script>

<script>
(function() {
  "use strict";

  /* ── DOM refs ──────────────────────────────────────── */
  var originEl      = document.getElementById("origin");
  var destEl        = document.getElementById("destination");
  const departEl      = document.getElementById("departure");
  const btnRoute      = document.getElementById("btn-route");
  const btnSwap       = document.getElementById("btn-swap");
  const mapDiv        = document.getElementById("map");
  const panelBody     = document.getElementById("panel-body");
  const placeholder   = document.getElementById("placeholder");
  const loadingEl     = document.getElementById("loading");
  const errorToast    = document.getElementById("error-toast");
  const summaryBar    = document.getElementById("summary-bar");
  const summaryText   = document.getElementById("summary-text");
  const sourcesText   = document.getElementById("sources-text");
  const routeMeta     = document.getElementById("route-meta");
  const metaDist      = document.getElementById("meta-distance");
  const metaDur       = document.getElementById("meta-duration");
  const metaRoute     = document.getElementById("meta-route");
  const alertsContainer = document.getElementById("alerts-container");
  const sliderBar      = document.getElementById("slider-bar");
  const sliderEl       = document.getElementById("departure-slider");
  const sliderLabel    = document.getElementById("slider-label");
  const sliderMinLabel = document.getElementById("slider-min-label");
  const sliderMaxLabel = document.getElementById("slider-max-label");
  const settingsBar    = document.getElementById("settings-bar");
  const speedSlider    = document.getElementById("speed-slider");
  const speedValue     = document.getElementById("speed-value");
  const restToggle     = document.getElementById("rest-toggle");
  const restOptions    = document.getElementById("rest-options");
  const restInterval   = document.getElementById("rest-interval");
  const restDuration   = document.getElementById("rest-duration");

  /* ── Map setup ─────────────────────────────────────── */
  let map;
  let routePolylines = [];
  let markers = [];
  let infoWindows = [];
  let fogOverlays = [];
  let currentSlots = null;
  let slotKeys = [];
  let currentRouteData = null;
  let cachedFullPath = null;
  let cachedPolyline = null;

  function initMap() {
    map = new google.maps.Map(mapDiv, {
      center: { lat: 38.5, lng: -122.5 },
      zoom: 8,
      mapTypeControl: false,
      streetViewControl: false,
      fullscreenControl: true,
      styles: [
        { featureType: "poi", stylers: [{ visibility: "off" }] },
        { featureType: "transit", stylers: [{ visibility: "off" }] }
      ]
    });
  }

  function clearMap() {
    routePolylines.forEach(function(p) { p.setMap(null); });
    routePolylines = [];
    markers.forEach(function(m) { m.setMap(null); });
    markers = [];
    infoWindows.forEach(function(iw) { iw.close(); });
    infoWindows = [];
    fogOverlays.forEach(function(o) { o.setMap(null); });
    fogOverlays = [];
  }

  /* ── Severity colors ───────────────────────────────── */
  const SEVERITY_COLORS = {
    green:  "#22c55e",
    yellow: "#eab308",
    red:    "#ef4444"
  };

  /* ── Draw route on map ─────────────────────────────── */
  function drawRoute(data, skipFitBounds) {
    clearMap();

    var encodedPath = data.route.polyline;
    var fullPath;
    if (cachedPolyline === encodedPath && cachedFullPath) {
      fullPath = cachedFullPath;
    } else {
      fullPath = google.maps.geometry.encoding.decodePath(encodedPath);
      cachedFullPath = fullPath;
      cachedPolyline = encodedPath;
    }
    var segments = data.segments;

    if (segments.length === 0) return;

    // Draw colored polyline segments between consecutive waypoints
    // First, map each point on the full path to the nearest segment
    for (var i = 0; i < segments.length - 1; i++) {
      var seg = segments[i];
      var nextSeg = segments[i + 1];
      var color = SEVERITY_COLORS[seg.severity_label] || "#22c55e";

      // Find the closest point indices on the full path for this and next segment
      var startIdx = closestPointIndex(fullPath, seg.location);
      var endIdx = closestPointIndex(fullPath, nextSeg.location);

      if (endIdx <= startIdx) endIdx = startIdx + 1;
      if (endIdx > fullPath.length) endIdx = fullPath.length;

      var subPath = fullPath.slice(startIdx, endIdx + 1);
      if (subPath.length < 2) continue;

      var polyline = new google.maps.Polyline({
        path: subPath,
        strokeColor: color,
        strokeOpacity: 0.85,
        strokeWeight: 5,
        map: map
      });
      routePolylines.push(polyline);
    }

    // Draw the last segment to the end of the route
    if (segments.length >= 1) {
      var lastSeg = segments[segments.length - 1];
      var lastColor = SEVERITY_COLORS[lastSeg.severity_label] || "#22c55e";
      var lastIdx = closestPointIndex(fullPath, lastSeg.location);
      var lastSubPath = fullPath.slice(lastIdx);
      if (lastSubPath.length >= 2) {
        var lastPolyline = new google.maps.Polyline({
          path: lastSubPath,
          strokeColor: lastColor,
          strokeOpacity: 0.85,
          strokeWeight: 5,
          map: map
        });
        routePolylines.push(lastPolyline);
      }
    }

    // Also draw a faint full-path underline for continuity
    var underline = new google.maps.Polyline({
      path: fullPath,
      strokeColor: "#94a3b8",
      strokeOpacity: 0.3,
      strokeWeight: 7,
      map: map,
      zIndex: 0
    });
    routePolylines.push(underline);

    // Add markers at each segment waypoint (skip rest stops)
    segments.forEach(function(seg, idx) {
      if (seg.type === "rest_stop") return;
      addWeatherMarker(seg, idx, idx === 0, idx === segments.length - 1);
    });

    // Add fog overlays for segments with fog (skip rest stops)
    segments.forEach(function(seg) {
      if (seg.type === "rest_stop") return;
      if (seg.weather && seg.weather.fog_level && seg.weather.fog_level !== "none") {
        addFogOverlay(seg);
      }
    });

    // Add rest stop markers
    segments.forEach(function(seg) {
      if (seg.type === "rest_stop") {
        var restMarker = new google.maps.Marker({
          position: { lat: seg.location.lat, lng: seg.location.lng },
          map: map,
          icon: {
            url: "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(restStopSvg()),
            scaledSize: new google.maps.Size(28, 28),
            anchor: new google.maps.Point(14, 14)
          },
          title: seg.place_name + " (" + seg.rest_duration_minutes + " min)",
          zIndex: 80
        });
        markers.push(restMarker);
      }
    });

    // Fit map to route bounds (skip when slider is changing to avoid map jumping)
    if (!skipFitBounds) {
      var bounds = new google.maps.LatLngBounds();
      fullPath.forEach(function(p) { bounds.extend(p); });
      map.fitBounds(bounds, { top: 20, right: 20, bottom: 20, left: 20 });
    }
  }

  function closestPointIndex(path, loc) {
    var minDist = Infinity;
    var minIdx = 0;
    var target = new google.maps.LatLng(loc.lat, loc.lng);
    for (var i = 0; i < path.length; i++) {
      var d = google.maps.geometry.spherical.computeDistanceBetween(path[i], target);
      if (d < minDist) {
        minDist = d;
        minIdx = i;
      }
    }
    return minIdx;
  }

  /* ── Weather markers ───────────────────────────────── */
  function addWeatherMarker(seg, idx, isStart, isEnd) {
    var w = seg.weather || {};
    var label = isStart ? "A" : (isEnd ? "B" : String(idx));
    var severityColor = SEVERITY_COLORS[seg.severity_label] || "#22c55e";

    // Build SVG marker icon
    var svg = markerSvg(severityColor, label);

    var marker = new google.maps.Marker({
      position: { lat: seg.location.lat, lng: seg.location.lng },
      map: map,
      icon: {
        url: "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(svg),
        scaledSize: new google.maps.Size(36, 44),
        anchor: new google.maps.Point(18, 44)
      },
      title: formatTime(seg.eta) + " - " + (w.condition_text || ""),
      zIndex: isStart || isEnd ? 100 : 50
    });

    var iwContent = buildInfoWindowContent(seg, isStart, isEnd);
    var infoWindow = new google.maps.InfoWindow({ content: iwContent });

    marker.addListener("click", function() {
      infoWindows.forEach(function(iw) { iw.close(); });
      infoWindow.open(map, marker);
    });

    markers.push(marker);
    infoWindows.push(infoWindow);
  }

  function markerSvg(color, label) {
    return '<svg xmlns="http://www.w3.org/2000/svg" width="36" height="44" viewBox="0 0 36 44">' +
      '<path d="M18 44 C18 44 2 26 2 16 A16 16 0 1 1 34 16 C34 26 18 44 18 44Z" fill="' + color + '" stroke="#fff" stroke-width="2"/>' +
      '<text x="18" y="20" text-anchor="middle" font-size="12" font-weight="bold" fill="#fff" font-family="sans-serif">' + escapeHtml(label) + '</text>' +
      '</svg>';
  }

  function restStopSvg() {
    return '<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 28 28">' +
      '<circle cx="14" cy="14" r="12" fill="#3b82f6" stroke="#fff" stroke-width="2"/>' +
      '<text x="14" y="18" text-anchor="middle" font-size="13" fill="#fff" font-family="sans-serif">R</text>' +
      '</svg>';
  }

  function buildInfoWindowContent(seg, isStart, isEnd) {
    var w = seg.weather || {};
    var label = isStart ? "Start" : (isEnd ? "Destination" : "Mile " + seg.mile_marker);
    var html = '<div class="iw-content">';
    html += '<div class="iw-title">' + escapeHtml(formatTime(seg.eta)) + ' - ' + escapeHtml(label) + '</div>';

    if (w.temperature_f !== null && w.temperature_f !== undefined) {
      html += '<div class="iw-row"><span class="iw-label">Temp</span><span>' + w.temperature_f + '&deg;F</span></div>';
    }
    if (w.condition_text) {
      html += '<div class="iw-row"><span class="iw-label">Conditions</span><span>' + escapeHtml(w.condition_text) + '</span></div>';
    }
    if (w.precipitation_probability) {
      html += '<div class="iw-row"><span class="iw-label">Precip</span><span>' + w.precipitation_probability + '%';
      if (w.rain_intensity && w.rain_intensity !== "none") {
        html += ' (' + w.rain_intensity + ')';
      }
      html += '</span></div>';
    }
    if (w.wind_speed_mph) {
      html += '<div class="iw-row"><span class="iw-label">Wind</span><span>' + w.wind_speed_mph + ' mph';
      if (w.wind_gusts_mph && w.wind_gusts_mph > w.wind_speed_mph) {
        html += ', gusts ' + w.wind_gusts_mph;
      }
      html += '</span></div>';
    }
    if (w.visibility_miles !== null && w.visibility_miles !== undefined && w.visibility_miles < 10) {
      html += '<div class="iw-row"><span class="iw-label">Visibility</span><span>' + w.visibility_miles + ' mi</span></div>';
    }
    if (w.fog_level && w.fog_level !== "none") {
      html += '<div class="iw-row"><span class="iw-label">Fog</span><span>' + capitalize(w.fog_level) + '</span></div>';
    }
    html += '<div class="iw-row"><span class="iw-label">Risk</span><span>' + capitalize(seg.severity_label) + ' (' + seg.severity_score + '/10)</span></div>';
    html += '</div>';
    return html;
  }

  /* ── Fog overlay (gray circle) ─────────────────────── */
  function addFogOverlay(seg) {
    var opacity = seg.weather.fog_level === "dense" ? 0.3 : 0.15;
    var radius = seg.weather.fog_level === "dense" ? 8000 : 5000;
    var circle = new google.maps.Circle({
      center: { lat: seg.location.lat, lng: seg.location.lng },
      radius: radius,
      fillColor: "#9ca3af",
      fillOpacity: opacity,
      strokeColor: "#9ca3af",
      strokeOpacity: 0.2,
      strokeWeight: 1,
      map: map,
      clickable: false,
      zIndex: 1
    });
    fogOverlays.push(circle);
  }

  /* ── Build instructions panel ──────────────────────── */
  function buildPanel(data) {
    var segments = data.segments;
    var route = data.route;
    var alerts = data.alerts || [];

    // Route metadata
    routeMeta.style.display = "flex";
    metaDist.textContent = route.total_distance_miles + " mi";
    // Compute adjusted duration from departure/arrival if available
    var adjustedMinutes = route.total_duration_minutes;
    if (route.departure && route.arrival) {
      var depMs = new Date(route.departure).getTime();
      var arrMs = new Date(route.arrival).getTime();
      if (!isNaN(depMs) && !isNaN(arrMs)) {
        adjustedMinutes = Math.round((arrMs - depMs) / 60000);
      }
    }
    metaDur.textContent = formatDuration(adjustedMinutes);
    metaRoute.textContent = route.summary || "";

    // Alerts at top of panel
    alertsContainer.innerHTML = "";
    alerts.forEach(function(alert) {
      var severityClass = (alert.severity === "severe" || alert.severity === "extreme") ? "severe" : (alert.severity === "moderate" ? "moderate" : "minor");
      var div = document.createElement("div");
      div.className = "alert-banner " + severityClass;
      var icon = severityClass === "severe" ? "&#9888;" : (severityClass === "moderate" ? "&#9888;" : "&#9432;");
      div.innerHTML =
        '<span class="alert-icon">' + icon + '</span>' +
        '<div>' +
          '<div class="alert-text">' + escapeHtml(alert.headline || alert.type || "Alert") + '</div>' +
          '<div class="alert-detail">Affects segments ' + (alert.affected_segments || []).map(function(s) { return s + 1; }).join(", ") + '</div>' +
        '</div>';
      alertsContainer.appendChild(div);
    });

    // Segment cards
    placeholder.style.display = "none";
    panelBody.innerHTML = "";

    segments.forEach(function(seg, idx) {
      // Rest stop pseudo-segment
      if (seg.type === "rest_stop") {
        var restCard = document.createElement("div");
        restCard.className = "rest-stop-card";
        restCard.innerHTML =
          '<div class="rest-header">&#9749; ' + escapeHtml(seg.place_name) + '</div>' +
          '<div class="rest-detail">' + formatTime(seg.eta_arrive) + ' \u2013 ' +
          formatTime(seg.eta_depart) + ' (' + seg.rest_duration_minutes + ' min rest)</div>' +
          '<div class="rest-detail">Mile ' + seg.mile_marker + '</div>';
        panelBody.appendChild(restCard);
        return;  // skip normal segment rendering for this iteration
      }

      var isLast = idx === segments.length - 1;
      var w = seg.weather || {};
      var rc = seg.road_conditions || {};

      var card = document.createElement("div");
      card.className = "segment-card";
      card.setAttribute("data-index", idx);

      // Severity bar
      var bar = document.createElement("div");
      bar.className = "severity-bar " + seg.severity_label;
      card.appendChild(bar);

      // Header: time and mile marker
      var header = document.createElement("div");
      header.className = "segment-header";
      var timeSpan = document.createElement("span");
      timeSpan.className = "segment-time";
      timeSpan.textContent = formatTime(seg.eta);
      header.appendChild(timeSpan);
      var mileSpan = document.createElement("span");
      mileSpan.className = "segment-mile";
      mileSpan.textContent = idx === 0 ? "Start" : (isLast ? "Arrive" : "Mile " + seg.mile_marker);
      header.appendChild(mileSpan);
      // Station badge (RWIS data source indicator)
      if (seg.station_name) {
        var stationSpan = document.createElement("span");
        stationSpan.className = "station-badge";
        stationSpan.textContent = seg.station_name + " RWIS";
        header.appendChild(stationSpan);
      }
      card.appendChild(header);

      // Weather line
      var weatherDiv = document.createElement("div");
      weatherDiv.className = "segment-weather";
      var weatherParts = [];
      if (w.temperature_f !== null && w.temperature_f !== undefined) {
        weatherParts.push('<span class="temp">' + w.temperature_f + '&deg;F</span>');
      }
      if (w.condition_text) {
        weatherParts.push(escapeHtml(w.condition_text));
      }
      var weatherLine = weatherParts.join(", ");

      // Precip badge
      if (w.rain_intensity && w.rain_intensity !== "none") {
        weatherLine += ' <span class="precip-badge ' + w.rain_intensity + '">' +
          capitalize(w.rain_intensity) + ' ' + (w.precipitation_type || "rain") +
          ' (' + (w.precipitation_probability || 0) + '%)</span>';
      } else if (w.precipitation_probability && w.precipitation_probability > 30) {
        weatherLine += ' <span class="precip-badge light">' + w.precipitation_probability + '% precip</span>';
      }

      weatherDiv.innerHTML = weatherLine;
      card.appendChild(weatherDiv);

      // Wind info
      if (w.wind_speed_mph && w.wind_speed_mph >= 15) {
        var windDiv = document.createElement("div");
        windDiv.className = "segment-wind";
        var arrowChar = windDirectionArrow(w.wind_direction_deg);
        windDiv.innerHTML = '<span class="wind-arrow">' + arrowChar + '</span> ' +
          w.wind_speed_mph + ' mph wind';
        if (w.wind_gusts_mph && w.wind_gusts_mph > w.wind_speed_mph) {
          windDiv.innerHTML += ', gusts ' + w.wind_gusts_mph + ' mph';
        }
        card.appendChild(windDiv);
      }

      // Fog info
      if (w.fog_level && w.fog_level !== "none") {
        var fogDiv = document.createElement("div");
        fogDiv.className = "segment-fog";
        fogDiv.textContent = capitalize(w.fog_level) + " fog" +
          (w.visibility_miles !== null && w.visibility_miles !== undefined ? " (vis: " + w.visibility_miles + " mi)" : "");
        card.appendChild(fogDiv);
      }

      // Light level indicator
      var ll = seg.light_level || "day";
      if (ll !== "day") {
        var lightDiv = document.createElement("div");
        lightDiv.className = "light-indicator " + ll;
        var icon = ll === "night" ? "\uD83C\uDF19" : "\uD83C\uDF05";
        lightDiv.textContent = icon + " " + capitalize(ll);
        if (seg.sunset) lightDiv.textContent += " (sunset " + seg.sunset + ")";
        card.appendChild(lightDiv);

        // Warning if low light + bad weather
        var hasHazard = (w.rain_intensity && w.rain_intensity !== "none") ||
                        (w.fog_level && w.fog_level !== "none") ||
                        (w.wind_speed_mph >= 25);
        if (hasHazard) {
          var warnDiv = document.createElement("div");
          warnDiv.className = "light-warning";
          warnDiv.textContent = "Low visibility driving " +
            (ll === "night" ? "after dark" : "at dusk/dawn") +
            " \u2014 consider adjusting departure";
          card.appendChild(warnDiv);
        }
      }

      // Turn instruction
      if (seg.turn_instruction) {
        var instrDiv = document.createElement("div");
        instrDiv.className = "segment-instruction" + (isLast ? " arrival" : "");
        instrDiv.textContent = isLast ? "Arrive at destination" : stripHtml(seg.turn_instruction);
        card.appendChild(instrDiv);
      } else if (isLast) {
        var arriveDiv = document.createElement("div");
        arriveDiv.className = "segment-instruction arrival";
        arriveDiv.textContent = "Arrive at destination";
        card.appendChild(arriveDiv);
      }

      // Per-segment alerts (road conditions)
      var segAlerts = (rc.alerts || []);
      segAlerts.forEach(function(a) {
        var alertDiv = document.createElement("div");
        var alertSev = (a.severity === "severe" || a.severity === "extreme") ? "severe" : "";
        alertDiv.className = "segment-alert " + alertSev;
        alertDiv.innerHTML = "&#9888; " + escapeHtml(a.headline || a.event || a.type || "Advisory");
        card.appendChild(alertDiv);
      });

      // Chain control
      if (rc.chain_control) {
        var ccDiv = document.createElement("div");
        ccDiv.className = "segment-alert severe";
        var ccLevel = rc.chain_control.level || "Active";
        ccDiv.innerHTML = "&#9888; Chain Control: " + escapeHtml(ccLevel);
        card.appendChild(ccDiv);
      }

      // Source links
      var sourceLinks = seg.source_links || {};
      var linkKeys = Object.keys(sourceLinks);
      if (linkKeys.length > 0) {
        var srcDiv = document.createElement("div");
        srcDiv.className = "segment-sources";
        var sourceLabels = {
          nws: "NWS Forecast",
          open_meteo: "Open-Meteo",
          tomorrow_io: "Tomorrow.io",
          caltrans: "Caltrans QuickMap"
        };
        linkKeys.forEach(function(key) {
          var a = document.createElement("a");
          a.href = sourceLinks[key];
          a.target = "_blank";
          a.rel = "noopener noreferrer";
          a.textContent = sourceLabels[key] || key;
          srcDiv.appendChild(a);
        });
        card.appendChild(srcDiv);
      }

      // Click handler: pan map and open info window
      card.addEventListener("click", function() {
        document.querySelectorAll(".segment-card").forEach(function(c) { c.classList.remove("active"); });
        card.classList.add("active");
        map.panTo({ lat: seg.location.lat, lng: seg.location.lng });
        map.setZoom(11);
        infoWindows.forEach(function(iw) { iw.close(); });
        if (infoWindows[idx]) {
          infoWindows[idx].open(map, markers[idx]);
        }
      });

      panelBody.appendChild(card);
    });
  }

  /* ── Route summary bar ─────────────────────────────── */
  function buildSummary(data) {
    var segments = data.segments;
    var alerts = data.alerts || [];
    var parts = [];

    // Identify precipitation zones
    var rainSegs = segments.filter(function(s) {
      return s.weather && s.weather.rain_intensity && s.weather.rain_intensity !== "none";
    });
    if (rainSegs.length > 0) {
      var heavyCount = rainSegs.filter(function(s) { return s.weather.rain_intensity === "heavy"; }).length;
      if (heavyCount > 0) {
        parts.push("Heavy rain expected on " + heavyCount + " segment(s).");
      } else {
        parts.push("Rain expected on " + rainSegs.length + " segment(s).");
      }
    }

    // Fog
    var fogSegs = segments.filter(function(s) {
      return s.weather && s.weather.fog_level && s.weather.fog_level !== "none";
    });
    if (fogSegs.length > 0) {
      var denseCount = fogSegs.filter(function(s) { return s.weather.fog_level === "dense"; }).length;
      if (denseCount > 0) {
        parts.push("Dense fog on " + denseCount + " segment(s) - reduced visibility.");
      } else {
        parts.push("Patchy fog on " + fogSegs.length + " segment(s).");
      }
    }

    // Wind
    var windSegs = segments.filter(function(s) {
      return s.weather && s.weather.wind_speed_mph >= 25;
    });
    if (windSegs.length > 0) {
      parts.push("Strong winds (" + Math.max.apply(null, windSegs.map(function(s) { return s.weather.wind_speed_mph; })) + " mph) on " + windSegs.length + " segment(s).");
    }

    // Low-light hazards
    var nightHazardSegs = segments.filter(function(s) {
      return s.type !== "rest_stop" && s.light_level && s.light_level !== "day" &&
        s.weather && (
          (s.weather.rain_intensity && s.weather.rain_intensity !== "none") ||
          (s.weather.fog_level && s.weather.fog_level !== "none")
        );
    });
    if (nightHazardSegs.length > 0) {
      parts.push("Low-light driving with weather hazards on " + nightHazardSegs.length + " segment(s).");
    }

    // Alerts
    alerts.forEach(function(a) {
      parts.push(a.headline || a.type || "Weather advisory active.");
    });

    // Chain controls
    var chainSegs = segments.filter(function(s) {
      return s.road_conditions && s.road_conditions.chain_control;
    });
    if (chainSegs.length > 0) {
      parts.push("Chain controls active on " + chainSegs.length + " segment(s).");
    } else {
      parts.push("No chain controls.");
    }

    // Overall severity
    var maxSeverity = Math.max.apply(null, segments.filter(function(s) { return s.type !== "rest_stop"; }).map(function(s) { return s.severity_score; }));
    if (maxSeverity <= 3) {
      parts.unshift("ROUTE SUMMARY: Conditions look good.");
    } else if (maxSeverity <= 6) {
      parts.unshift("ROUTE SUMMARY: Use caution on some segments.");
    } else {
      parts.unshift("ROUTE SUMMARY: Significant hazards on this route. Drive carefully.");
    }

    summaryText.textContent = parts.join("  ");
    sourcesText.textContent = "Sources: " + (data.sources || []).join(", ");
    summaryBar.style.display = "block";
  }

  function initSlider(data) {
    currentSlots = data.slots;
    currentRouteData = data;
    slotKeys = Object.keys(currentSlots).sort();

    if (slotKeys.length === 0) {
      sliderBar.style.display = "none";
      return;
    }

    sliderEl.min = 0;
    sliderEl.max = slotKeys.length - 1;

    // Find the index of the selected departure
    var selectedKey = data.slider_range.selected;
    var selectedIdx = slotKeys.indexOf(selectedKey);
    if (selectedIdx < 0) {
      selectedIdx = 0;
      var selectedDate = new Date(selectedKey).getTime();
      var bestDiff = Infinity;
      for (var i = 0; i < slotKeys.length; i++) {
        var diff = Math.abs(new Date(slotKeys[i]).getTime() - selectedDate);
        if (diff < bestDiff) {
          bestDiff = diff;
          selectedIdx = i;
        }
      }
    }

    sliderEl.value = selectedIdx;
    sliderMinLabel.textContent = formatSliderTime(slotKeys[0]);
    sliderMaxLabel.textContent = formatSliderTime(slotKeys[slotKeys.length - 1]);
    updateSliderLabel(selectedIdx);
    sliderBar.style.display = "block";
  }

  function updateSliderLabel(idx) {
    sliderLabel.textContent = "Departure: " + formatSliderTime(slotKeys[idx]);
  }

  function onSliderChange() {
    var idx = parseInt(sliderEl.value, 10);
    updateSliderLabel(idx);

    var key = slotKeys[idx];
    var slotData = currentSlots[key];
    if (!slotData) return;

    var displayData = {
      route: Object.assign({}, currentRouteData.route, {
        departure: slotData.departure,
        arrival: slotData.arrival,
      }),
      segments: slotData.segments,
      alerts: slotData.alerts,
      sources: currentRouteData.sources,
    };

    drawRoute(displayData, true);
    buildPanel(displayData);
    buildSummary(displayData);
  }

  /* ── API call ──────────────────────────────────────── */
  function fetchRoute() {
    var origin = originEl.value.trim();
    var dest = destEl.value.trim();
    var departure = departEl.value;

    if (!origin || !dest || !departure) {
      showError("Please fill in all fields: origin, destination, and departure time.");
      return;
    }

    showLoading(true);
    btnRoute.disabled = true;

    var url = "/api/route-weather?" +
      "origin=" + encodeURIComponent(origin) +
      "&destination=" + encodeURIComponent(dest) +
      "&departure=" + encodeURIComponent(departure) +
      "&speed_factor=" + speedSlider.value +
      "&rest_enabled=" + restToggle.checked +
      "&rest_interval=" + restInterval.value +
      "&rest_duration=" + restDuration.value;

    fetch(url)
      .then(function(resp) {
        if (!resp.ok) {
          return resp.json().catch(function() {
            return {};
          }).then(function(body) {
            throw new Error(body.error || "Request failed with status " + resp.status);
          });
        }
        return resp.json();
      })
      .then(function(data) {
        showLoading(false);
        btnRoute.disabled = false;

        if (!data.segments || data.segments.length === 0) {
          showError("No route segments returned. Please check your origin and destination.");
          return;
        }

        drawRoute(data);
        buildPanel(data);
        buildSummary(data);
        initSlider(data);
        settingsBar.style.display = "block";
      })
      .catch(function(err) {
        showLoading(false);
        btnRoute.disabled = false;
        showError(err.message || "An unexpected error occurred. Please try again.");
      });
  }

  /* ── Loading / Error helpers ───────────────────────── */
  function showLoading(visible) {
    if (visible) {
      loadingEl.classList.add("visible");
    } else {
      loadingEl.classList.remove("visible");
    }
  }

  var errorTimeout = null;
  function showError(msg) {
    errorToast.textContent = msg;
    errorToast.classList.add("visible");
    if (errorTimeout) clearTimeout(errorTimeout);
    errorTimeout = setTimeout(function() {
      errorToast.classList.remove("visible");
    }, 6000);
  }

  /* ── Utility functions ─────────────────────────────── */
  function formatTime(isoStr) {
    if (!isoStr) return "";
    try {
      var d = new Date(isoStr);
      return d.toLocaleTimeString("en-US", { hour: "numeric", minute: "2-digit", hour12: true });
    } catch (e) {
      return isoStr;
    }
  }

  function formatDuration(minutes) {
    if (!minutes) return "";
    var h = Math.floor(minutes / 60);
    var m = minutes % 60;
    if (h === 0) return m + " min";
    if (m === 0) return h + " hr";
    return h + " hr " + m + " min";
  }

  function formatSliderTime(isoStr) {
    if (!isoStr) return "--";
    var d = new Date(isoStr);
    var days = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
    var months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    return days[d.getDay()] + " " + months[d.getMonth()] + " " + d.getDate() + ", " +
      d.toLocaleTimeString("en-US", { hour: "numeric", minute: "2-digit", hour12: true });
  }

  function capitalize(s) {
    if (!s) return "";
    return s.charAt(0).toUpperCase() + s.slice(1);
  }

  function escapeHtml(str) {
    if (!str) return "";
    var div = document.createElement("div");
    div.appendChild(document.createTextNode(str));
    return div.innerHTML;
  }

  function stripHtml(str) {
    if (!str) return "";
    var tmp = document.createElement("div");
    tmp.innerHTML = str;
    return tmp.textContent || tmp.innerText || "";
  }

  function windDirectionArrow(deg) {
    // Wind direction is where wind comes FROM; arrow points in the direction it blows TO
    if (deg === null || deg === undefined) return "";
    // Map degree to arrow character (pointing in direction wind blows)
    var arrows = ["\u2193", "\u2199", "\u2190", "\u2196", "\u2191", "\u2197", "\u2192", "\u2198"];
    var idx = Math.round(deg / 45) % 8;
    return arrows[idx];
  }

  /* ── Event listeners ───────────────────────────────── */
  btnSwap.addEventListener("click", function() {
    var tmp = originEl.value;
    originEl.value = destEl.value;
    destEl.value = tmp;
  });

  btnRoute.addEventListener("click", fetchRoute);

  // Enter key on departure input triggers route fetch
  departEl.addEventListener("keydown", function(e) {
    if (e.key === "Enter") { e.preventDefault(); fetchRoute(); }
  });

  sliderEl.addEventListener("input", onSliderChange);

  speedSlider.addEventListener("input", function() {
    speedValue.textContent = parseFloat(speedSlider.value).toFixed(2) + "x";
  });

  restToggle.addEventListener("change", function() {
    restOptions.classList.toggle("visible", restToggle.checked);
  });

  /* ── Autocomplete helper ─────────────────────────────── */
  function setupAutocomplete(inputEl) {
    var ac = new google.maps.places.PlaceAutocompleteElement({
      componentRestrictions: { country: "us" },
    });

    ac.style.width = inputEl.style.width || "200px";

    var confirmedValue = inputEl.value;
    var parent = inputEl.parentNode;
    var nextSibling = inputEl.nextSibling;

    // Replace the original input with the autocomplete element
    parent.replaceChild(ac, inputEl);

    // Detect API failure: if the inner input doesn't render within 3s, restore original
    var restored = false;
    var restoreTimer = setTimeout(function() {
      try {
        var inner = ac.shadowRoot && ac.shadowRoot.querySelector("input");
        if (!inner) {
          console.warn("Autocomplete element did not render, restoring plain input");
          parent.replaceChild(inputEl, ac);
          restored = true;
        }
      } catch (e) {
        parent.replaceChild(inputEl, ac);
        restored = true;
      }
    }, 3000);

    // When a place is selected from dropdown, store its formatted address
    ac.addEventListener("gmp-placeselect", async function(e) {
      clearTimeout(restoreTimer);
      var place = e.place;
      await place.fetchFields({ fields: ["formattedAddress"] });
      confirmedValue = place.formattedAddress || "";
    });

    // Enter key triggers route fetch
    ac.addEventListener("keydown", function(e) {
      if (e.key === "Enter") { e.preventDefault(); fetchRoute(); }
    });

    function getInnerInputValue() {
      try {
        var inner = ac.shadowRoot && ac.shadowRoot.querySelector("input");
        return inner ? inner.value.trim() : "";
      } catch (e) {
        return "";
      }
    }

    return {
      get value() {
        if (restored) return inputEl.value.trim();
        var typed = getInnerInputValue();
        if (typed && typed !== confirmedValue) return typed;
        return confirmedValue;
      },
      set value(v) {
        confirmedValue = v;
        if (restored) {
          inputEl.value = v;
        } else {
          try {
            var inner = ac.shadowRoot && ac.shadowRoot.querySelector("input");
            if (inner) inner.value = v;
          } catch (e) {}
        }
      },
      el: ac,
    };
  }

  /* ── Init ──────────────────────────────────────────── */

  // Set departure to tomorrow at 8:00 AM by default
  (function() {
    var tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    tomorrow.setHours(8, 0, 0, 0);
    var pad = function(n) { return String(n).padStart(2, "0"); };
    var iso = tomorrow.getFullYear() + "-" + pad(tomorrow.getMonth() + 1) + "-" + pad(tomorrow.getDate()) +
              "T" + pad(tomorrow.getHours()) + ":" + pad(tomorrow.getMinutes());
    departEl.value = iso;
    // Also set min to now so the browser date picker blocks past times
    var now = new Date();
    var nowIso = now.getFullYear() + "-" + pad(now.getMonth() + 1) + "-" + pad(now.getDate()) +
                 "T" + pad(now.getHours()) + ":" + pad(now.getMinutes());
    departEl.min = nowIso;
  })();

  Promise.all([
    google.maps.importLibrary("maps"),
    google.maps.importLibrary("geometry"),
  ]).then(function() {
    initMap();

    // Load Places separately so map works even if Places fails
    google.maps.importLibrary("places").then(function() {
      try {
        originEl = setupAutocomplete(originEl);
        destEl = setupAutocomplete(destEl);
      } catch (err) {
        console.warn("Places autocomplete unavailable:", err);
      }
    }).catch(function(err) {
      console.warn("Places library failed to load:", err);
    });
  });

})();
</script>

</body>
</html>
